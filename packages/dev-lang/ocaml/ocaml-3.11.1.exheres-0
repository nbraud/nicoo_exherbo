# Copyright 2009 A Frederick Christensen <fauxmight@nosocomia.com>
# Distributed under the terms of the GNU General Public License v2
# Based in part on 'ocaml-3.10.2.exheres-0', which is
#     Copyright 2008 Saleem Abdulrasool <compnerd@compnerd.org>

require ocaml flag-o-matic multilib

SLOT="0"
LICENCES="|| ( LGPL-2 QPL-1.0 )"
PLATFORMS="~amd64 ~x86 ~ppc"
MYOPTIONS="
    X
    ocamlopt [[ description = [ Adds support for OCaml native code compiler ] ]]
    threads
    ncurses
"

DEPENDENCIES="
    build+run:
        ncurses? ( sys-libs/ncurses )
"

# FIXME - excluded call-ld-with-proper-ldfflags.patch
#     This was needed in previous versions but appears
#     to no longer be necessary -- !!VERIFY!!

# FIMXE - todo -- add the pieces of the configure patch from gentoo's
#                 3.11.1 set
#         todo -- ONLY filter fomit-frame-pointer during the
#                 compilation of opt
#         todo -- add option for tk support and perhaps dbm

DEFAULT_SRC_PREPARE_PATCHES=( "${FILES}/${PNV}-exec-stack-fixes.patch"
                              "${FILES}/${PNV}-configure.patch"
                              "${FILES}/${PNV}-automagic.patch" )

src_configure() {
    # ocamlopt uses -pg. -pg and -fomit-frame-pointer conflict
    option ocamlopt && filter-flags -fomit-frame-pointer

    edo ./configure                                             \
        $(option ncurses || echo "-no-curses")                  \
        $(option threads || echo "-no-pthread")                 \
        $(option X || echo "--no-graph")                        \
        --host ${CHOST}                                         \
        --prefix /usr                                           \
        --bindir /usr/bin                                       \
        --libdir /usr/$(get_libdir)/ocaml                       \
        --mandir /usr/share/man                                 \
        --no-tk --no-dbm
}

